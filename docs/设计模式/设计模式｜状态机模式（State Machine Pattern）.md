---
title: 设计模式(5)｜状态机模式（State Machine Pattern）
date: 2024-04-03
---
状态机模式（State Machine Pattern）是一种用于描述对象的行为软件设计模式，属于行为型设计模式。在状态机模式中，对象的行为取决于其内部状态，并且在不同的状态下，对象可能会有不同的行为。状态机模式通常涉及定义一组状态以及状态之间的转换规则。
# 结构
该模式主要包含以下几个要素：

1.  **状态（State）**：状态机模式中的状态表示对象所处的特定状态。每个状态都定义了对象在该状态下的行为。
2.  **上下文（Context）**：上下文是包含状态机的对象。它维护了当前状态，并在状态之间的转换发生时更新状态。
3.  **转换（Transition）**：转换描述了对象从一个状态转移到另一个状态的过程。它通常受到一些条件或触发事件的影响。
4.  **动作（Action）**：动作是状态转换期间可能执行的操作或行为。

状态机模式的核心思想是将对象的行为与其状态解耦，从而使得状态之间的转换更加清晰和可控。它有助于简化复杂系统的设计和实现，特别是当系统具有多个可能状态和状态之间的复杂转换关系时。
# 使用步骤
在应用状态机模式时，通常可以采用以下步骤：

1.  **确定状态**：
    首先，确定系统中可能存在的状态。这些状态应该涵盖系统的所有可能情况，并且每个状态应该有清晰的定义和目的。
2.  **定义状态接口**：
    根据确定的状态，创建一个状态接口或抽象类，其中包含状态可能的行为。每个状态都应该实现这个接口，并提供相应的行为。
3.  **实现具体状态类**：
    对于每个状态，创建具体的状态类来实现状态接口。在这些具体类中，实现状态的具体行为，以及在状态转换时可能需要执行的操作。
4.  **设计状态转换规则**：
    确定状态之间的转换规则。这些规则可能会受到外部条件或事件的影响。定义转换规则可以帮助您确定何时应该从一个状态转换到另一个状态。
5.  **实现状态机**：
    创建一个包含状态的上下文类，该类负责维护当前状态并在状态转换时更新状态。在上下文类中，提供方法来执行状态之间的转换。
6.  **测试和验证**：
    编写测试用例来验证状态机的正确性。测试应该覆盖各种可能的状态转换情况，并确保系统在不同情况下的行为符合预期。
7.  **优化和扩展**：
    在实际应用中，您可能需要优化状态机的性能或扩展其功能。可以通过调整状态之间的转换规则或添加新的状态和行为来实现这一点。

这些步骤可以帮助您在设计和实现状态机时保持清晰的思路，并确保最终的系统符合预期的需求。
# 示例
```java
// 灯泡类
class LightBulb {
    private State onState;
    private State offState;
    private State currentState;

    public LightBulb() {
        onState = new OnState(this);
        offState = new OffState(this);
        // 初始状态为关闭状态
        currentState = offState;
    }

    public void setState(State state) {
        currentState = state;
    }

    public void turnOn() {
        currentState.turnOn();
    }

    public void turnOff() {
        currentState.turnOff();
    }

    // 获取开启状态
    public State getOnState() {
        return onState;
    }

    // 获取关闭状态
    public State getOffState() {
        return offState;
    }
}

// 具体的状态实现类 - 开启状态
class OnState implements State {
    private LightBulb lightBulb;

    public OnState(LightBulb lightBulb) {
        this.lightBulb = lightBulb;
    }

    @Override
    public void turnOn() {
        System.out.println("灯泡已经是开启状态了");
    }

    @Override
    public void turnOff() {
        System.out.println("关闭灯泡");
        lightBulb.setState(lightBulb.getOffState()); // 将状态设置为关闭状态
    }
}

// 具体的状态实现类 - 关闭状态
class OffState implements State {
    private LightBulb lightBulb;

    public OffState(LightBulb lightBulb) {
        this.lightBulb = lightBulb;
    }

    @Override
    public void turnOn() {
        System.out.println("打开灯泡");
        lightBulb.setState(lightBulb.getOnState()); // 将状态设置为开启状态
    }

    @Override
    public void turnOff() {
        System.out.println("灯泡已经是关闭状态了");
    }
}

public class StateMachineTest {
    public static void main(String[] args) {
        LightBulb lightBulb = new LightBulb();

        // 开启灯泡
        lightBulb.turnOn();

        // 关闭灯泡
        lightBulb.turnOff();

        // 再次开启灯泡
        lightBulb.turnOn();
    }
}
```
测试代码
```java
public class StateMachineTest {
    public static void main(String[] args) {
        LightBulb lightBulb = new LightBulb();

        // 开启灯泡
        lightBulb.turnOn();

        // 关闭灯泡
        lightBulb.turnOff();

        // 再次开启灯泡
        lightBulb.turnOn();
    }
}
```

1. 开启灯泡：调用 `turnOn()` 方法，灯泡应该从关闭状态变为开启状态，打印出 "打开灯泡"。
2. 关闭灯泡：调用 `turnOff()` 方法，灯泡应该从开启状态变为关闭状态，打印出 "关闭灯泡"。
3. 再次开启灯泡：调用 `turnOn()` 方法，此时灯泡已经是开启状态了，所以应该打印出 "灯泡已经是开启状态了"。
# 使用状态机的场景
状态机在许多领域都有广泛的使用场景，包括但不限于以下几个方面：

1.  **游戏开发**：
    游戏中的角色、NPC、道具等都可以被建模成状态机。例如，角色的行为可以根据游戏场景和角色状态的变化而变化，比如角色移动、攻击、防御等。
2.  **工作流程管理**：
    许多应用程序需要处理复杂的工作流程，例如审批流程、订单处理流程等。状态机可以很好地描述这些流程，并根据当前状态自动触发相应的操作。
3.  **通信协议**：
    在通信协议中，状态机经常被用来描述协议的状态转换和行为。例如，TCP协议中的连接建立和断开过程，以及HTTP协议中的请求和响应过程，都可以用状态机来描述。
4.  **自动化控制系统**：
    自动化控制系统（例如工厂生产线、机器人控制系统等）中的各种设备和操作也可以使用状态机来进行建模和控制。状态机可以帮助系统管理设备的状态和控制设备的行为。
5.  **电子设计自动化（EDA）**：
    在电子设计领域，状态机经常被用来描述硬件设计中的控制逻辑。例如，有限状态机（FSM）在硬件设计中被广泛应用于描述序列逻辑电路的行为。
6.  **编译器和解释器**：
    在编译器和解释器的实现中，状态机常用于词法分析和语法分析阶段。例如，正则表达式引擎中的状态机用于解析和匹配字符串。

总的来说，状态机适用于需要描述对象行为随着时间和外部条件变化而变化的各种情况。通过将系统分解成一系列状态和状态转换规则，状态机可以帮助我们更清晰地理解系统的行为，并实现复杂系统的控制和管理。
# 常见面试题
在面试中，可能会遇到以下与状态机相关的问题：

1. **什么是状态机模式？**
    - 答案：状态机模式是一种软件设计模式，用于描述对象的行为。它基于对象的状态，定义了对象在不同状态下可能的行为，并规定了状态之间的转换规则。

2. **状态机模式的优缺点是什么？**
    - 优点：
        - 清晰地描述了对象的行为随着状态的变化而变化。
        - 状态之间的转换规则清晰明确，易于理解和维护。
        - 可以帮助简化复杂系统的设计和实现。
    - 缺点：
        - 对于简单的系统可能会显得过于复杂。
        - 如果状态过多或状态之间的转换关系复杂，可能会导致状态机变得笨重和难以管理。

3. **状态机模式和策略模式有何区别？**
    - 答案：状态机模式和策略模式都涉及到根据对象的状态来改变行为，但它们的重点不同。状态机模式侧重于描述对象的状态和状态之间的转换规则，而策略模式侧重于定义一系列算法，并使得这些算法可以相互替换，以影响对象的行为。

4. **举例说明状态机模式在实际项目中的应用。**
    - 答案：状态机模式在许多实际项目中都有应用，例如：
        - 游戏开发中，描述角色的行为随着游戏进程和玩家操作的变化而变化。
        - 工作流程管理系统中，描述工作流程中各个步骤的状态和转换规则。
        - 通信协议中，描述通信协议的状态和状态转换规则，如TCP连接的建立和断开过程。

5. **有限状态机（FSM）和无限状态机（USM）有何区别？**
    - 答案：有限状态机（FSM）具有有限数量的状态，并且在任何时间点只能处于其中一个状态。而无限状态机（USM）可以具有无限数量的状态，对象的行为取决于其当前状态和外部条件，可以动态地添加或删除状态。

6. **描述状态机模式的基本结构。**
    - 答案：状态机模式的基本结构包含上下文（Context）、状态（State）、具体状态（ConcreteState）等组件。上下文维护了当前状态，并在状态之间的转换发生时更新状态；状态接口定义了状态的行为；具体状态类实现了状态接口，并定义了状态的具体行为。

以上问题和答案可以帮助更好地理解状态机模式，并展示其在实际项目中的应用和优势。


