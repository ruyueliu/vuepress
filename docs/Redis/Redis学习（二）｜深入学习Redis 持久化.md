---
title: Redis学习（二）｜深入学习Redis 持久化
date: 2024-04-25
---
<!-- TOC -->
* [什么是 Redis 的持久化](#什么是-redis-的持久化)
* [**RDB 持久化**](#rdb-持久化)
  * [工作原理](#工作原理)
  * [特点](#特点)
    * [优点](#优点)
    * [缺点](#缺点)
  * [使用场景](#使用场景)
  * [配置和调优](#配置和调优)
* [**AOF 持久化**](#aof-持久化)
  * [工作原理](#工作原理-1)
  * [特点](#特点-1)
    * [优点](#优点-1)
    * [缺点](#缺点-1)
  * [使用场景](#使用场景-1)
  * [配置和调优](#配置和调优-1)
* [RDB vs AOF](#rdb-vs-aof)
* [AOF vs 幂等](#aof-vs-幂等)
* [Redis 的持久化功能配置](#redis-的持久化功能配置)
  * [RDB or AOF](#rdb-or-aof)
    * [设置 RDB 持久化](#设置-rdb-持久化)
    * [设置 AOF 持久化](#设置-aof-持久化)
    * [重启 Redis 服务](#重启-redis-服务)
  * [RDB 持久化配置](#rdb-持久化配置)
  * [AOF 持久化配置](#aof-持久化配置)
  * [其他配置](#其他配置)
* [持久化策略选择](#持久化策略选择)
* [持久化命令](#持久化命令)
* [利用持久化文件进行数据恢复](#利用持久化文件进行数据恢复)
    * [使用 RDB 文件进行数据恢复](#使用-rdb-文件进行数据恢复)
    * [使用 AOF 文件进行数据恢复](#使用-aof-文件进行数据恢复)
* [**持久化性能调优**](#持久化性能调优)
<!-- TOC -->

# 什么是 Redis 的持久化
Redis 的持久化是指将 Redis 在内存中的数据写入到持久化存储介质（通常是磁盘）上，以便在 Redis 服务器重启时能够恢复数据。持久化是为了保证数据不会因服务器故障或重启而丢失。Redis 提供了两种主要的持久化方式：RDB 持久化和AOF 持久化。
# **RDB 持久化**
理解 RDB（Redis DataBase）持久化需要从其工作原理、特点和使用场景等方面进行理解：
## 工作原理
RDB 持久化通过周期性地将 Redis 内存中的数据快照（Snapshot）保存到磁盘上的二进制文件中来实现。在执行 RDB 持久化时，Redis 主进程会fork出一个子进程，子进程负责将当前内存中的数据写入到 RDB 文件中，完成后再替换原来的 RDB 文件。
## 特点
### 优点

- **全量备份**：RDB 持久化是一种全量备份的方式，它会保存 Redis 在某个时间点上的完整数据快照，包括所有键值对及其相关信息。
- **快速恢复**：由于 RDB 文件是一个二进制文件，加载速度较快，适合用于快速恢复数据。
- **节省空间**：RDB 文件通常比 AOF 文件小，占用的磁盘空间较少，因为它只保存了 Redis 在某个时间点上的数据快照，而不是所有写命令。
### 缺点
虽然 RDB 持久化有许多优点，但也存在一些缺点，包括：

-  **数据丢失风险**：由于 RDB 持久化是定期生成数据快照并保存到磁盘上的，因此在两次快照之间的时间段内，如果发生服务器故障或宕机，可能会丢失最近一次快照之后的数据。
-  **数据恢复耗时**：当 Redis 服务器重启时，需要将 RDB 文件加载到内存中以恢复数据。对于大型的 RDB 文件，加载过程可能会耗费较长时间，导致服务的停机时间较长。
-  **频繁写入影响性能**：在执行 RDB 持久化时，Redis 主进程会 fork 出一个子进程，将内存中的数据写入到 RDB 文件中，这个过程会对服务器的性能产生一定的影响，尤其是在数据量较大时。
-  **不适用于实时数据备份**：由于 RDB 持久化是定期执行的，无法实时记录数据的变更操作，因此不适用于需要实时备份数据的场景，可能会导致部分数据的丢失。
-  **文件格式不适合解析**：RDB 文件是一个二进制文件，其格式不够友好，不容易被人类读取和解析。因此在需要查看或处理 RDB 文件时可能会比较困难。

虽然 RDB 持久化具有高效、简单的特点，但也存在一些缺点，特别是在数据一致性和实时性方面存在一定的局限性。因此，在选择持久化方式时，需要根据实际需求权衡各种因素。
## 使用场景

- **备份数据**：RDB 持久化可以用于备份 Redis 数据，保证数据在服务器重启时不会丢失。
- **全量恢复**：当需要对 Redis 进行全量数据恢复时，可以使用 RDB 文件进行恢复操作。
- **定期备份**：可以通过配置定期保存 RDB 文件的方式进行定期备份，保证数据的安全性和可靠性。

总的来说，RDB 持久化是一种简单、高效的持久化方式，适用于需要全量备份和快速恢复数据的场景。
## 配置和调优
在使用 RDB 持久化时，可以通过配置参数来调整持久化的策略和频率，如保存 RDB 文件的间隔时间、最小保存的数据变化量等参数，以满足不同的需求。
# **AOF 持久化**
理解 AOF（Append Only File）持久化需要从其工作原理、特点和使用场景等方面进行理解：
## 工作原理
AOF 持久化通过记录 Redis 的写命令来实现。当执行写命令时，Redis 会将写命令追加到 AOF 文件的末尾，以记录数据的变更操作。在服务器重启时，Redis 会重新执行 AOF 文件中保存的所有写命令，从而恢复数据。
## 特点
### 优点

- **实时记录**：AOF 持久化实时记录 Redis 的写命令，能够准确地记录每一次数据变更操作，保证数据的实时性。
- **可读性**：AOF 文件是一个文本文件，保存了 Redis 执行过的所有写命令，因此比较容易被人类读取和解析，方便进行数据恢复和处理。
- **适用于数据安全性要求高的场景**：由于 AOF 持久化实时记录写命令，因此在服务器宕机或异常关闭时，只会丢失最近一次写命令之后的数据变更操作，而不会丢失整个数据集。

总的来说，AOF 持久化是一种实时记录 Redis 写命令的持久化方式，具有实时性强、可读性好、安全性高等特点，适用于对数据安全性要求较高的场景。
### 缺点
虽然 AOF（Append Only File）持久化具有许多优点，但也存在一些缺点，包括：

1.  **文件体积较大**：由于 AOF 文件记录了 Redis 的每一条写命令，因此在长时间运行的情况下，AOF 文件可能会变得非常大。这会占用大量的磁盘空间，并可能导致文件读写的性能下降。
2.  **写操作影响性能**：AOF 持久化将每一条写命令都追加到文件末尾，这会导致频繁的磁盘写入操作，可能会对性能产生一定的影响，尤其是在高并发的写入场景下。
3.  **数据恢复耗时**：当 Redis 服务器重启时，需要重新加载 AOF 文件中保存的所有写命令来恢复数据。对于大型的 AOF 文件，这个过程可能会耗费较长时间，导致服务的停机时间较长。
4.  **数据恢复点不精确**：由于 AOF 文件是按照写命令追加到文件末尾的方式记录的，因此在服务器故障或宕机时，可能会丢失最后一次写命令之后的数据。虽然 Redis 支持 AOF 文件的 fsync 选项来控制数据的同步频率，但是将 fsync 配置为 always 会影响写入性能，将 fsync 配置为 everysec 则可能会存在一定的数据丢失风险。
5.  **数据恢复不可靠**：AOF 文件是一个文本文件，如果在写入过程中发生异常或意外中断，可能会导致 AOF 文件损坏或不完整，从而影响数据的恢复。此外，AOF 文件中的写命令格式是 Redis 自定义的，因此可能存在版本兼容性和解析难度的问题。

综上所述，尽管 AOF 持久化具有实时记录、可读性好、安全性高等优点，但也存在一些缺点，特别是在磁盘空间占用、性能影响、数据恢复耗时等方面存在一定的局限性。因此，在选择持久化方式时，需要根据实际需求权衡各种因素。
## 使用场景

- **实时备份**：AOF 持久化适用于需要实时备份数据的场景，保证数据的实时性和安全性。
- **数据恢复**：当 Redis 服务器重启时，可以通过重新执行 AOF 文件中保存的写命令来恢复数据。
- **防止数据丢失**：AOF 持久化可以最大程度地避免数据丢失，保证数据的完整性和一致性。
## 配置和调优
在使用 AOF 持久化时，可以通过配置参数来调整持久化的策略和性能，如设置 AOF 文件重写的触发条件、AOF 文件的同步方式等。
# RDB vs AOF
RDB 和 AOF 是 Redis 中两种主要的持久化方式，它们在工作原理、特点和使用场景等方面有所不同。下面是 RDB 和 AOF 的对比：

1.  **工作原理**：
- RDB：RDB 持久化通过生成快照（Snapshot）来实现，定期将内存中的数据保存到磁盘上的二进制文件中。
- AOF：AOF 持久化通过记录 Redis 的写命令来实现，将写命令追加到文件末尾，以记录数据的变更操作。
2.  **数据恢复**：
- RDB：RDB 持久化适用于全量备份和全量数据恢复，加载速度快，但可能会丢失最近一次快照之后的数据。
- AOF：AOF 持久化适用于实时备份和实时数据恢复，保证数据的实时性和安全性，但可能会有较长的数据恢复时间。
3.  **文件格式**：
- RDB：RDB 文件是一个二进制文件，保存了 Redis 在某个时间点上的完整数据快照，加载速度快，但不易读取和解析。
- AOF：AOF 文件是一个文本文件，保存了 Redis 执行过的所有写命令，易读取和解析，方便进行数据恢复和处理。
4.  **文件体积**：
- RDB：RDB 文件通常比 AOF 文件小，占用的磁盘空间较少。
- AOF：AOF 文件通常比较大，占用的磁盘空间较多，尤其是在长时间运行时。
5.  **写入性能**：
- RDB：RDB 持久化在执行快照保存时会 fork 出一个子进程，可能会影响服务器的写入性能。
- AOF：AOF 持久化将每一条写命令都追加到文件末尾，可能会影响服务器的写入性能，尤其是在高并发写入的场景下。
6.  **数据恢复精确度**：
- RDB：RDB 持久化可能会丢失最近一次快照之后的数据，恢复的精确度不如 AOF。
- AOF：AOF 持久化实时记录写命令，数据恢复精确度高，可以最大程度地避免数据丢失。
7.  **配置和调优**：
- RDB：RDB 持久化可以通过配置保存快照的频率和触发条件来进行调优。
- AOF：AOF 持久化可以通过配置 AOF 文件重写的触发条件和同步方式来进行调优。

综上所述，RDB 和 AOF 持久化各有优点和缺点，适用于不同的使用场景。一般来说，RDB 适用于全量备份和快速恢复的场景，而 AOF 适用于实时备份和实时数据恢复的场景。在选择持久化方式时，需要根据实际需求和场景进行权衡和选择。
# AOF vs 幂等
在考虑使用 AOF 重写时，确保其幂等性是很重要的。<br />幂等性是指无论执行多少次相同的操作，结果都是一致的。在 AOF 重写的情况下，如果不考虑幂等性，可能会导致以下问题：

1.  **重写后数据不一致**：如果 AOF 重写不具备幂等性，即使在相同的输入下执行多次，重写生成的 AOF 文件也可能会不同。这可能导致数据不一致的问题，因为在不同的服务器上执行相同的 AOF 重写操作可能会得到不同的结果。
2.  **重写后数据丢失或损坏**：如果 AOF 重写不具备幂等性，并且在重写过程中发生了错误或中断，可能会导致生成的 AOF 文件不完整或损坏。这可能会导致数据丢失或损坏的问题，从而影响数据的恢复和可靠性。

因此，在设计和实现 AOF 重写时，确保其具备幂等性是非常重要的。可以通过以下方法来确保 AOF 重写的幂等性：

1.  **原子操作**：确保 AOF 重写是原子操作，即整个重写过程是不可分割的，要么执行完整，要么不执行。这可以通过事务或者其他原子操作机制来实现。
2.  **Idempotent Data Transformations**：确保重写过程中的数据转换是幂等的，即对于相同的输入，转换的结果是一致的。这意味着即使执行多次相同的数据转换操作，结果也是相同的。
3.  **幂等性检查**：在执行 AOF 重写之前，可以进行幂等性检查，确保重写操作的输入和状态与之前的重写操作相同。如果检测到重写操作已经完成或者已经在进行中，可以避免重复执行重写操作。

通过确保 AOF 重写具备幂等性，可以提高系统的稳定性和可靠性，避免数据不一致、丢失或损坏的问题。
# Redis 的持久化功能配置
要配置 Redis 的持久化功能，需要修改 Redis 的配置文件（通常是 redis.conf），通过设置相应的参数来配置 RDB 和 AOF 持久化。以下是一些常用的持久化配置参数以及它们的含义
## RDB or AOF
要设置 Redis 使用 RDB 还是 AOF 持久化，需要编辑 Redis 的配置文件（通常是 redis.conf），并修改 `save` 和 `appendonly` 参数。
### 设置 RDB 持久化

- 打开 Redis 的配置文件（通常是 redis.conf）。
- 找到 `save` 参数，并确保它被设置为你期望的值。如果你希望 Redis 使用 RDB 持久化，你可以设置 `save` 参数为 `save <seconds> <changes>`，其中 `<seconds>` 表示多长时间内有多少次写操作时执行一次 RDB 持久化。例如，`save 900 1` 表示在 900 秒内如果至少有 1 次写操作，则执行一次 RDB 持久化。
- 确保 `appendonly` 参数被设置为 `no`，以禁用 AOF 持久化。如果 `appendonly yes`，则表示开启了 AOF 持久化。
### 设置 AOF 持久化

- 打开 Redis 的配置文件（通常是 redis.conf）。
- 确保 `save` 参数被注释掉或设置为合适的值，以避免与 AOF 持久化冲突。
- 找到 `appendonly` 参数，并将其设置为 `yes`，以开启 AOF 持久化。
### 重启 Redis 服务

- 在修改完配置文件后，需要重启 Redis 服务使配置生效。可以使用 `redis-server` 命令启动 Redis 服务，或者使用系统提供的服务管理工具（如 systemd、init.d 等）。

通过以上步骤，可以设置 Redis 使用 RDB 持久化还是 AOF 持久化，或者两者同时使用。根据实际需求和场景，选择合适的持久化方式。
## RDB 持久化配置

- `save <seconds> <changes>`：设置在多长时间内有多少次写操作时执行一次 RDB 持久化。例如，`save 900 1` 表示在 900 秒内如果至少有 1 次写操作，则执行一次 RDB 持久化。
- `stop-writes-on-bgsave-error yes/no`：当执行 RDB 持久化出错时，是否停止写入操作。
- `rdbcompression yes/no`：是否对 RDB 文件进行压缩。
- `rdbchecksum yes/no`：是否对 RDB 文件进行校验和检查。
- `dbfilename <filename>`：设置 RDB 文件的名称。
## AOF 持久化配置

- `appendonly yes/no`：是否开启 AOF 持久化。
- `appendfilename <filename>`：设置 AOF 文件的名称。
- `appendfsync always/everysec/no`：设置 AOF 文件同步策略，`always` 表示每次写操作都进行同步，`everysec` 表示每秒进行一次同步，`no` 表示不进行同步。
- `no-appendfsync-on-rewrite yes/no`：在 AOF 重写时是否禁止同步。
- `auto-aof-rewrite-percentage <percentage>`：设置 AOF 文件重写的触发条件，当 AOF 文件增长到当前大小的一定百分比时触发重写。
- `auto-aof-rewrite-min-size <size>`：设置 AOF 文件重写的最小大小，只有当 AOF 文件大小超过该值时才触发重写。
## 其他配置

- `dir <directory>`：设置持久化文件（RDB 和 AOF 文件）的存储路径。
- `stop-writes-on-bgsave-error yes/no`：当执行 RDB 持久化出错时，是否停止写入操作。

根据实际需求，可以根据上述参数来配置 Redis 的持久化功能。修改配置文件后，需要重启 Redis 服务使配置生效。
# 持久化策略选择
选择合适的持久化策略需要考虑多个因素，包括数据的重要性、性能需求、存储成本和可用性等。以下是一些指导性建议，可帮助选择合适的持久化策略：<br />**数据重要性**：

- 如果数据对实时性要求较高，且不能容忍丢失任何数据，则应该选择 AOF 持久化，因为它能够实时记录每次写操作，保证数据的实时性和安全性。
- 如果数据的实时性要求不高，且可以接受一定程度的数据丢失，则可以考虑使用 RDB 持久化，它能够定期生成数据快照，提供相对较好的恢复能力。

**性能需求**：

- 如果应用对性能要求较高，例如需要高并发读写操作或低延迟响应，那么可以考虑关闭持久化功能或选择 RDB 持久化，因为它对服务器的性能影响较小。
- 如果数据安全性和可靠性是首要考虑的因素，并且性能要求不是特别苛刻，那么可以选择 AOF 持久化，以保证数据的安全性和持久性。

**存储成本**：

- 如果存储资源有限，且无法承受大量的磁盘空间消耗，则应该选择 RDB 持久化，因为它生成的快照文件通常比较小。
- 如果存储资源相对充裕，且对数据完整性和可读性要求较高，则可以选择 AOF 持久化，虽然它生成的文件通常比较大，但可以提供更好的数据恢复能力。

**容灾和可用性**：

- 如果应用对容灾和高可用性有较高的要求，需要确保在服务器故障或重启时能够快速恢复数据，并且数据丢失的程度要尽可能小，则可以选择同时使用 RDB 和 AOF 持久化，以提供多层次的数据保护和备份。

在选择合适的持久化策略时，需要综合考虑以上因素，并根据实际需求和场景进行权衡和选择。在一些情况下，也可以根据实际情况灵活调整持久化策略，例如根据数据的重要性和访问模式，动态地调整持久化参数和配置。
# 持久化命令
Redis 提供了一些与持久化相关的命令，用于手动触发持久化操作、查看持久化状态等。以下是一些常用的与持久化相关的 Redis 命令：

1.  **SAVE**：该命令用于阻塞服务器进程，直到 RDB 快照完成为止，即将当前内存中的数据保存到磁盘上的 RDB 文件中。
```
SAVE
```

2.  **BGSAVE**：该命令用于异步执行 RDB 快照操作，不会阻塞服务器进程。它会 fork 出一个子进程来执行 RDB 持久化操作。
```
BGSAVE
```

3.  **LASTSAVE**：该命令用于获取最近一次成功执行持久化操作的时间戳，即最近一次生成 RDB 文件或追加 AOF 文件的时间。
```
LASTSAVE
```

4.  **BGREWRITEAOF**：该命令用于异步执行 AOF 文件重写操作，它会优化 AOF 文件，删除冗余的命令以减少文件大小。
```
BGREWRITEAOF
```

5.  **AOF REWRITE**：该命令用于同步执行 AOF 文件重写操作，会阻塞服务器进程，直到 AOF 重写完成为止。
```
AOF REWRITE
```

6.  **AOF SCHEDULE**：该命令用于调度 AOF 重写操作，在后台异步执行 AOF 文件重写操作。
```
AOF SCHEDULE
```

7.  **CONFIG GET**：该命令用于获取 Redis 的配置参数，可以用于查看和调整与持久化相关的配置参数。
```
CONFIG GET <parameter>
```

8.  **CONFIG SET**：该命令用于设置 Redis 的配置参数，可以用于调整与持久化相关的配置参数。
```
CONFIG SET <parameter> <value>
```

通过使用这些命令，你可以手动触发持久化操作、查看持久化状态和配置参数，以及进行持久化参数的调整和优化。
# 利用持久化文件进行数据恢复
使用持久化文件进行数据恢复通常涉及到两种情况：使用 RDB 文件进行数据恢复和使用 AOF 文件进行数据恢复。以下是使用这两种持久化文件进行数据恢复的步骤：
### 使用 RDB 文件进行数据恢复

1.  **停止 Redis 服务**：首先，停止正在运行的 Redis 服务器，确保没有新的写入操作对数据进行更改。
2.  **备份原始数据文件**：在进行数据恢复之前，最好先备份当前的数据文件，以防止意外。
3.  **将 RDB 文件移动到 Redis 数据目录**：将要恢复的 RDB 文件移动到 Redis 的数据目录中。
4.  **启动 Redis 服务器**：使用 `redis-server` 命令启动 Redis 服务器。在启动过程中，Redis 会检测到数据目录中存在 RDB 文件，并尝试加载其中的数据。
5.  **等待数据加载完成**：等待 Redis 加载完 RDB 文件中的数据。加载过程中，可以查看日志文件以了解加载进度和任何可能的错误信息。
6.  **验证数据恢复**：在 Redis 启动完成后，可以通过连接到 Redis 并执行一些查询命令来验证数据是否成功恢复。
### 使用 AOF 文件进行数据恢复

1.  **停止 Redis 服务**：同样，首先停止正在运行的 Redis 服务器。
2.  **备份原始数据文件**：备份当前的 AOF 文件，以防止意外。
3.  **删除旧的 AOF 文件**：删除当前的 AOF 文件，因为在进行数据恢复时，通常会使用新的 AOF 文件替换旧的文件。
4.  **将备份 AOF 文件移动到 Redis 数据目录**：将备份的 AOF 文件移动到 Redis 的数据目录中，并确保文件名与 Redis 配置文件中的配置一致。
5.  **启动 Redis 服务器**：使用 `redis-server` 命令启动 Redis 服务器。在启动过程中，Redis 会加载新的 AOF 文件中的数据。
6.  **等待数据加载完成**：等待 Redis 加载完 AOF 文件中的数据，可以查看日志文件以了解加载进度和任何可能的错误信息。
7.  **验证数据恢复**：在 Redis 启动完成后，通过连接到 Redis 并执行一些查询命令来验证数据是否成功恢复。

无论是使用 RDB 文件还是 AOF 文件进行数据恢复，都需要确保文件的完整性和正确性，并在恢复过程中注意监控和处理可能出现的错误和异常情况。
# **持久化性能调优**
调优持久化功能可以帮助提高 Redis 的性能和可靠性，下面是一些常用的调优方法：

1.  **选择合适的持久化方式**：
- 根据应用的实际需求和场景，选择合适的持久化方式（RDB 或 AOF），或者同时使用两种持久化方式。
- 如果对数据的实时性要求较高，并且可以接受一定的性能损耗，可以选择使用 AOF 持久化。
- 如果对性能要求较高，并且可以容忍一定程度的数据丢失，可以选择使用 RDB 持久化。
2.  **调整持久化参数**：
- 对于 RDB 持久化，可以调整 `save` 参数来设置执行快照的频率和触发条件，以控制持久化操作的频率。
- 对于 AOF 持久化，可以调整 `appendfsync` 参数来设置 AOF 文件同步策略，以控制数据同步的频率和可靠性。
3.  **定期进行持久化文件优化**：
- 对于 AOF 持久化，定期进行 AOF 文件重写操作，删除冗余的写命令以减少文件大小，提高文件写入和读取性能。
- 对于 RDB 持久化，定期进行 RDB 文件压缩操作，删除过期或冗余的数据以减少文件大小，提高加载和恢复性能。
4.  **合理配置持久化相关参数**：
- 配置合理的文件路径和文件名，确保持久化文件存储在快速的存储介质上，以提高读写性能。
- 配置合理的持久化参数，例如最大重写时间、重写触发条件等，以确保持久化操作不会对系统性能产生过大的影响。
5.  **监控持久化性能**：
- 定期监控持久化操作的性能指标，包括持久化文件的大小、生成和加载速度、同步延迟等，及时发现和解决性能瓶颈和问题。
6.  **定期进行持久化文件备份**：
- 定期备份持久化文件，以防止意外情况导致文件损坏或丢失，确保数据的安全性和可靠性。

通过以上调优方法，可以优化 Redis 的持久化功能，提高系统的性能和可靠性，适应不同的应用场景和需求。在调优过程中，需要根据实际情况和监控数据进行合理的参数配置和优化策略。


